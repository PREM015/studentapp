// This is your Prisma schema file
// Learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  STUDENT
  TEACHER
  TPC
  CLUB
  UNIVERSITY
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum AttendanceMethod {
  QR_CODE
  CODE_ENTRY
  MANUAL
}

enum AssignmentStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
}

enum CourseStatus {
  ACTIVE
  COMPLETED
  UPCOMING
}

enum EventType {
  CONFERENCE
  WORKSHOP
  COMPETITION
  SEMINAR
  SOCIAL
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
  REGISTRATION_OPEN
}

enum JobType {
  FULL_TIME
  PART_TIME
  INTERNSHIP
  CONTRACT
}

enum JobStatus {
  OPEN
  CLOSED
  FILLED
}

enum ApplicationStatus {
  APPLIED
  UNDER_REVIEW
  SHORTLISTED
  REJECTED
  ACCEPTED
  WITHDRAWN
}

enum ClubCategory {
  TECHNICAL
  CULTURAL
  SPORTS
  SOCIAL
  ACADEMIC
}

enum NotificationType {
  ASSIGNMENT
  ATTENDANCE
  GRADE
  EVENT
  ANNOUNCEMENT
  ALERT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
}

enum FileType {
  PDF
  IMAGE
  DOCUMENT
  VIDEO
  OTHER
}

enum FileCategory {
  DOCUMENTS
  CERTIFICATES
  IDS
  PHOTOS
  ASSIGNMENTS
  TRANSCRIPTS
  OTHER
}

enum CalendarEventType {
  CLASS
  EXAM
  DEADLINE
  EVENT
  HOLIDAY
}

// Models
model User {
  id            Int        @id @default(autoincrement())
  email         String     @unique
  name          String
  password      String
  role          UserRole
  profileImage  String?
  status        UserStatus @default(ACTIVE)
  emailVerified DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relations
  student       Student?
  teacher       Teacher?
  notifications Notification[]
  vaultFiles    VaultFile[]

  @@index([email])
  @@index([role])
  @@index([status])
}

model Student {
  id            Int      @id @default(autoincrement())
  userId        Int      @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rollNo        String   @unique
  department    String
  batch         String
  semester      Int
  section       String
  cgpa          Float    @default(0)
  attendance    Float    @default(0)
  phone         String
  dateOfBirth   DateTime
  address       String?
  guardianName  String?
  guardianPhone String?
  joinDate      DateTime
  points        Int      @default(0)
  rank          Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  badges             StudentBadge[]
  enrollments        CourseEnrollment[]
  attendanceRecords  AttendanceRecord[]
  assignments        StudentAssignment[]
  grades             Grade[]
  eventRegistrations EventRegistration[]
  jobApplications    JobApplication[]
  clubMemberships    ClubMembership[]
  leaderboardEntry   LeaderboardEntry?

  @@index([rollNo])
  @@index([department])
  @@index([batch])
  @@index([userId])
}

model Teacher {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employeeId     String   @unique
  department     String
  designation    String
  specialization String[]
  phone          String
  officeRoom     String
  officeHours    String
  joinDate       DateTime
  totalStudents  Int      @default(0)
  rating         Float    @default(0)
  publications   Int      @default(0)
  experience     String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  courses      Course[]
  education    Education[]
  achievements Achievement[]
  clubs        Club[]        @relation("FacultyAdvisor")

  @@index([employeeId])
  @@index([department])
  @@index([userId])
}

model Education {
  id         Int      @id @default(autoincrement())
  teacherId  Int
  teacher    Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  degree     String
  university String
  year       String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([teacherId])
}

model Achievement {
  id        Int      @id @default(autoincrement())
  teacherId Int
  teacher   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  title     String
  year      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
}

model StudentBadge {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  badge     String
  awardedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, badge])
  @@index([studentId])
}

model Department {
  id           Int      @id @default(autoincrement())
  name         String   @unique
  code         String   @unique
  hod          String
  facultyCount Int      @default(0)
  studentCount Int      @default(0)
  courseCount  Int      @default(0)
  labCount     Int      @default(0)
  achievements String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([code])
  @@index([name])
}

model Course {
  id           Int          @id @default(autoincrement())
  code         String       @unique
  name         String
  credits      Int
  semester     Int
  department   String
  instructorId Int
  instructor   Teacher      @relation(fields: [instructorId], references: [id])
  maxCapacity  Int
  syllabus     String       @db.Text
  description  String       @db.Text
  progress     Int          @default(0)
  status       CourseStatus @default(UPCOMING)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  schedules         CourseSchedule[]
  enrollments       CourseEnrollment[]
  attendanceRecords AttendanceRecord[]
  assignments       Assignment[]
  grades            Grade[]
  calendarEvents    CalendarEvent[]

  @@index([code])
  @@index([department])
  @@index([semester])
  @@index([instructorId])
  @@index([status])
}

model CourseSchedule {
  id        Int      @id @default(autoincrement())
  courseId  Int
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  day       String
  time      String
  room      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
}

model CourseEnrollment {
  id         Int      @id @default(autoincrement())
  studentId  Int
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId   Int
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrolledAt DateTime @default(now())

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
}

model AttendanceRecord {
  id        Int               @id @default(autoincrement())
  studentId Int
  student   Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId  Int
  course    Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  date      DateTime
  status    AttendanceStatus
  markedAt  DateTime? // FIXED: Changed from String? to DateTime?
  method    AttendanceMethod?
  latitude  Float?
  longitude Float?
  createdAt DateTime          @default(now())

  @@unique([studentId, courseId, date])
  @@index([studentId])
  @@index([courseId])
  @@index([date])
  @@index([status])
}

model Assignment {
  id          Int      @id @default(autoincrement())
  title       String
  courseId    Int
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  description String   @db.Text
  dueDate     DateTime
  totalPoints Int
  attachments String[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rubrics     RubricCriteria[]
  submissions StudentAssignment[]

  @@index([courseId])
  @@index([dueDate])
}

model RubricCriteria {
  id           Int        @id @default(autoincrement())
  assignmentId Int
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  criteria     String
  points       Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([assignmentId])
}

model StudentAssignment {
  id              Int              @id @default(autoincrement())
  studentId       Int
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  assignmentId    Int
  assignment      Assignment       @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  status          AssignmentStatus @default(NOT_STARTED)
  submittedAt     DateTime?
  submittedPoints Int?
  grade           String?
  feedback        String?          @db.Text
  attachments     String[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([studentId, assignmentId])
  @@index([studentId])
  @@index([assignmentId])
  @@index([status])
}

model Grade {
  id          Int      @id @default(autoincrement())
  studentId   Int
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId    Int
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  assignments Json
  quizzes     Json
  finalExam   Json
  totalScore  Float
  grade       String
  letterGrade String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@index([letterGrade])
}

model Event {
  id          Int         @id @default(autoincrement())
  title       String
  type        EventType
  date        DateTime
  time        String
  location    String
  organizer   String
  description String      @db.Text
  maxCapacity Int
  status      EventStatus @default(UPCOMING)
  tags        String[]
  image       String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  registrations  EventRegistration[]
  calendarEvents CalendarEvent[]

  @@index([date])
  @@index([status])
  @@index([type])
}

model EventRegistration {
  id           Int      @id @default(autoincrement())
  studentId    Int
  student      Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  eventId      Int
  event        Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  registeredAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([studentId, eventId])
  @@index([studentId])
  @@index([eventId])
}

model Company {
  id                  Int        @id @default(autoincrement())
  name                String
  logo                String?
  industry            String
  location            String
  employeeCount       String
  website             String
  description         String     @db.Text
  averagePackage      String
  recruitmentDrive    String?
  eligibilityCriteria String
  contactPerson       String?
  contactEmail        String?
  status              UserStatus @default(ACTIVE)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  // Relations
  jobPostings JobPosting[]

  @@index([name])
  @@index([status])
}

model JobPosting {
  id                  Int       @id @default(autoincrement())
  companyId           Int
  company             Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  title               String
  type                JobType
  location            String
  duration            String?
  stipend             String?
  package             String?
  description         String    @db.Text
  requirements        String[]
  skills              String[]
  applicationDeadline DateTime
  status              JobStatus @default(OPEN)
  postedDate          DateTime  @default(now())
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  applications JobApplication[]

  @@index([companyId])
  @@index([status])
  @@index([applicationDeadline])
  @@index([type])
}

model JobApplication {
  id          Int               @id @default(autoincrement())
  studentId   Int
  student     Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  jobId       Int
  job         JobPosting        @relation(fields: [jobId], references: [id], onDelete: Cascade)
  appliedAt   DateTime          @default(now())
  status      ApplicationStatus @default(APPLIED) // FIXED: Changed from String to enum
  resume      String?
  coverLetter String?           @db.Text
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@unique([studentId, jobId])
  @@index([studentId])
  @@index([jobId])
  @@index([status])
}

model Club {
  id            Int          @id @default(autoincrement())
  name          String       @unique
  logo          String?
  category      ClubCategory
  description   String       @db.Text
  president     String
  vicePresident String?
  facultyId     Int
  faculty       Teacher      @relation("FacultyAdvisor", fields: [facultyId], references: [id])
  email         String
  instagram     String?
  twitter       String?
  linkedin      String?
  achievements  String[]
  status        UserStatus   @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  memberships ClubMembership[]
  events      ClubEvent[]

  @@index([category])
  @@index([status])
  @@index([facultyId])
}

model ClubMembership {
  id        Int      @id @default(autoincrement())
  studentId Int
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  clubId    Int
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  position  String?
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, clubId])
  @@index([studentId])
  @@index([clubId])
}

model ClubEvent {
  id          Int      @id @default(autoincrement())
  clubId      Int
  club        Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  title       String
  date        DateTime
  description String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clubId])
  @@index([date])
}

model Notification {
  id        Int                  @id @default(autoincrement())
  userId    Int
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  timestamp DateTime             @default(now())
  read      Boolean              @default(false)
  priority  NotificationPriority @default(MEDIUM)
  link      String?
  icon      String?

  @@index([userId])
  @@index([read])
  @@index([timestamp])
  @@index([type])
}

model VaultFile {
  id         Int          @id @default(autoincrement())
  userId     Int
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  type       FileType
  size       Int
  category   FileCategory
  tags       String[]
  url        String?
  uploadedAt DateTime     @default(now())

  @@index([userId])
  @@index([category])
  @@index([type])
}

model CalendarEvent {
  id          Int               @id @default(autoincrement())
  title       String
  type        CalendarEventType
  date        DateTime
  startTime   String
  endTime     String?
  location    String?
  instructor  String?
  description String?           @db.Text
  color       String
  courseId    Int?
  course      Course?           @relation(fields: [courseId], references: [id], onDelete: SetNull)
  eventId     Int?
  event       Event?            @relation(fields: [eventId], references: [id], onDelete: SetNull)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@index([date])
  @@index([type])
  @@index([courseId])
  @@index([eventId])
}

model Analytics {
  id                    Int      @id @default(autoincrement())
  date                  DateTime @default(now())
  totalStudents         Int
  activeStudents        Int
  topPerformers         Int
  atRiskStudents        Int
  overallAttendance     Float
  overallCGPA           Float
  totalPlacements       Int
  averagePackage        String
  highestPackage        String
  companiesVisited      Int
  offersReceived        Int
  placementRate         Float
  totalCourses          Int
  activeCourses         Int
  completedCourses      Int
  averageClassSize      Float
  monthlyAttendanceData Json
  createdAt             DateTime @default(now())

  @@index([date])
}

model LeaderboardEntry {
  id        Int      @id @default(autoincrement())
  studentId Int      @unique
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade) // FIXED: Added relation
  name      String
  points    Int
  badges    Int
  avatar    String?
  rank      Int
  updatedAt DateTime @updatedAt

  @@index([studentId]) // FIXED: Added index
  @@index([rank])
  @@index([points])
}
